<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script>
// Particles.js
particlesJS('particles-js', {
    particles: {
        number: { value: 80, density: { enable: true, value_area: 800 } },
        color: { value: "#00ff88" },
        shape: { type: "circle" },
        opacity: { value: 0.5, random: true },
        size: { value: 3, random: true },
        line_linked: {
            enable: true,
            distance: 150,
            color: "#0088ff",
            opacity: 0.4,
            width: 1
        },
        move: {
            enable: true,
            speed: 2,
            direction: "none",
            random: true,
            straight: false,
            out_mode: "out",
            bounce: false
        }
    },
    interactivity: {
        detect_on: "canvas",
        events: {
            onhover: { enable: true, mode: "repulse" },
            onclick: { enable: true, mode: "push" }
        }
    }
});

let systemKey = '';
let currentAdminSession = '';
let isKeyVerified = false; // Key durumu

// Tab deƒüi≈ütirme - D√úZELTƒ∞LDƒ∞
function openTab(tabName) {
    // Key tab'ƒ± hari√ß diƒüer tablarƒ± key kontrol√º yap
    if (tabName !== 'key-tab' && !isKeyVerified) {
        alert('‚ùå √ñnce key doƒürulamasƒ± yapƒ±n!');
        openTab('key-tab');
        return;
    }
    
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    event.currentTarget.classList.add('active');
}

// Key doƒürulama - D√úZELTƒ∞LDƒ∞
async function verifySystemKey() {
    const key = document.getElementById('systemKey').value;
    const messageDiv = document.getElementById('keyMessage');

    if (!key) {
        messageDiv.innerHTML = '<p style="color: #ff4444; font-weight: bold;">‚ùå Key giriniz!</p>';
        return;
    }

    try {
        const response = await fetch('/api/admin/verify-key', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key })
        });
        
        const data = await response.json();
        console.log('Key verification response:', data);

        if (data.success) {
            systemKey = key;
            isKeyVerified = true;
            messageDiv.innerHTML = '<p style="color: #00ff88; font-weight: bold;">‚úÖ Key doƒürulandƒ±! Sorgu yapabilirsiniz.</p>';
            
            // TC tab'ƒ±nƒ± a√ß
            setTimeout(() => {
                openTab('tc-tab');
            }, 1000);
            
        } else {
            messageDiv.innerHTML = '<p style="color: #ff4444; font-weight: bold;">‚ùå ' + (data.message || 'Ge√ßersiz key!') + '</p>';
        }
    } catch (error) {
        console.error('Key verification error:', error);
        messageDiv.innerHTML = '<p style="color: #ff4444; font-weight: bold;">‚ùå Key doƒürulama hatasƒ±!</p>';
    }
}

// Sorgu yapma - KEY KONTROL√ú EKLENDƒ∞
async function sorgula(type) {
    if (!systemKey || !isKeyVerified) {
        alert('‚ùå √ñnce key doƒürulamasƒ± yapƒ±n!');
        openTab('key-tab');
        return;
    }

    const loading = document.getElementById('loading');
    const result = document.getElementById('result');
    const resultData = document.getElementById('resultData');
    
    loading.classList.add('active');
    result.classList.remove('active');
    
    let params = { key: systemKey };
    
    // Parametreleri ayarla
    switch(type) {
        case 'tc':
        case 'tcpro':
        case 'hayathikayesi':
        case 'yas':
        case 'tapu':
        case 'isyeri':
        case 'adres':
        case 'hane':
        case 'apartman':
        case 'aile':
        case 'ailepro':
        case 'es':
        case 'sulale':
        case 'tcgsm':
            const tcValue = document.getElementById('tc' + (type === 'tcgsm' ? 'Gsm' : '')).value;
            if (!tcValue) {
                alert('TC kimlik numarasƒ± girin!');
                loading.classList.remove('active');
                return;
            }
            params.tc = tcValue;
            break;
            
        case 'gsmtc':
            const gsmValue = document.getElementById('gsm').value;
            if (!gsmValue) {
                alert('GSM numarasƒ± girin!');
                loading.classList.remove('active');
                return;
            }
            params.gsm = gsmValue;
            break;
            
        case 'adsoyad':
        case 'adsoyadpro':
            params.ad = document.getElementById('ad').value || '';
            params.soyad = document.getElementById('soyad').value || '';
            params.il = document.getElementById('il').value || '';
            params.ilce = document.getElementById('ilce').value || '';
            break;
            
        case 'adililce':
            params.ad = document.getElementById('ad').value || '';
            params.il = document.getElementById('il').value || '';
            break;
            
        case 'ip':
        case 'dns':
        case 'whois':
        case 'subdomain':
            const domainValue = document.getElementById('domain').value;
            if (!domainValue) {
                alert('IP/Domain girin!');
                loading.classList.remove('active');
                return;
            }
            params.domain = domainValue;
            break;
            
        case 'leak':
            const leakValue = document.getElementById('leakQuery').value;
            if (!leakValue) {
                alert('E-posta girin!');
                loading.classList.remove('active');
                return;
            }
            params.query = leakValue;
            break;
            
        case 'telegram':
            const telegramValue = document.getElementById('telegramUser').value;
            if (!telegramValue) {
                alert('Telegram kullanƒ±cƒ± adƒ± girin!');
                loading.classList.remove('active');
                return;
            }
            params.kullanici = telegramValue;
            break;
            
        case 'gelismisip':
            const ipValue = document.getElementById('gelismisIp').value;
            if (!ipValue) {
                alert('IP adresi girin!');
                loading.classList.remove('active');
                return;
            }
            params.ip = ipValue;
            break;
            
        case 'vergino':
            const vergiValue = document.getElementById('vergiNo').value;
            if (!vergiValue) {
                alert('Vergi numarasƒ± girin!');
                loading.classList.remove('active');
                return;
            }
            params.vergi = vergiValue;
            break;
            
        case 'adaparsel':
            params.il = document.getElementById('ilAda').value || '';
            params.ada = document.getElementById('ada').value || '';
            params.parsel = document.getElementById('parsel').value || '';
            break;
    }
    
    try {
        const queryString = new URLSearchParams(params).toString();
        console.log('Sending request:', `/api/${type}?${queryString}`);
        
        const response = await fetch(`/api/${type}?${queryString}`);
        const data = await response.json();
        
        console.log('Response:', data);
        
        if (data.error) {
            resultData.textContent = 'Hata: ' + data.error;
        } else {
            resultData.textContent = JSON.stringify(data, null, 2);
        }
        currentResult = data;
        
    } catch (error) {
        console.error('Sorgu hatasƒ±:', error);
        resultData.textContent = 'Hata: ' + error.message;
    } finally {
        loading.classList.remove('active');
        result.classList.add('active');
    }
}

// Admin fonksiyonlarƒ± - KEY Lƒ∞STESƒ∞ G√úNCELLEME EKLENDƒ∞
function openAdminModal() {
    document.getElementById('adminModal').style.display = 'block';
    checkAdminSession();
}

function closeAdminModal() {
    document.getElementById('adminModal').style.display = 'none';
}

async function checkAdminSession() {
    if (!currentAdminSession) return;
    
    try {
        const response = await fetch('/api/admin/check-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId: currentAdminSession })
        });
        const data = await response.json();

        if (data.success) {
            document.getElementById('adminLoginSection').style.display = 'none';
            document.getElementById('adminPanelSection').style.display = 'block';
            loadCurrentKeys();
        }
    } catch (error) {
        console.log('Session kontrol hatasƒ±');
    }
}

async function adminLogin() {
    const username = document.getElementById('adminUsername').value;
    const password = document.getElementById('adminPassword').value;
    const messageDiv = document.getElementById('adminMessage');

    if (!username || !password) {
        messageDiv.innerHTML = '<p style="color: #ff4444;">‚ùå Kullanƒ±cƒ± adƒ± ve ≈üifre girin!</p>';
        return;
    }

    try {
        const response = await fetch('/api/admin/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        const data = await response.json();

        if (data.success) {
            currentAdminSession = data.sessionId;
            document.getElementById('adminLoginSection').style.display = 'none';
            document.getElementById('adminPanelSection').style.display = 'block';
            messageDiv.innerHTML = '<p style="color: #00ff88;">‚úÖ ' + data.message + '</p>';
            loadCurrentKeys();
        } else {
            messageDiv.innerHTML = '<p style="color: #ff4444;">‚ùå ' + data.message + '</p>';
        }
    } catch (error) {
        messageDiv.innerHTML = '<p style="color: #ff4444;">‚ùå Giri≈ü hatasƒ±!</p>';
    }
}

async function createKey() {
    const key = document.getElementById('newKey').value;
    const messageDiv = document.getElementById('adminMessage');

    if (!key) {
        messageDiv.innerHTML = '<p style="color: #ff4444;">‚ùå Key girin!</p>';
        return;
    }

    try {
        const response = await fetch('/api/admin/create-key', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key, sessionId: currentAdminSession })
        });
        const data = await response.json();

        if (data.success) {
            messageDiv.innerHTML = '<p style="color: #00ff88;">‚úÖ ' + data.message + '</p>';
            document.getElementById('newKey').value = '';
            // Yeni key listesini g√ºncelle
            if (data.keys) {
                updateKeysList(data.keys);
            } else {
                loadCurrentKeys(); // Fallback
            }
        } else {
            messageDiv.innerHTML = '<p style="color: #ff4444;">‚ùå ' + data.message + '</p>';
        }
    } catch (error) {
        messageDiv.innerHTML = '<p style="color: #ff4444;">‚ùå Key olu≈üturma hatasƒ±!</p>';
    }
}

// Key listesini g√ºncelle - YENƒ∞ EKLENDƒ∞
function updateKeysList(keys) {
    const keysDiv = document.getElementById('currentKeys');
    keysDiv.innerHTML = keys.map(key => `
        <div style="padding: 5px; margin: 2px 0; background: rgba(0,255,136,0.1); border-radius: 5px;">
            üîë ${key}
        </div>
    `).join('');
}

async function loadCurrentKeys() {
    try {
        const response = await fetch('/api/admin/keys', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId: currentAdminSession })
        });
        const data = await response.json();

        if (data.success && data.keys) {
            updateKeysList(data.keys);
        } else {
            // Fallback
            const keysDiv = document.getElementById('currentKeys');
            keysDiv.innerHTML = '<div style="padding: 5px; margin: 2px 0; background: rgba(0,255,136,0.1); border-radius: 5px;">üîë DABBE2024VIP</div>';
        }
    } catch (error) {
        const keysDiv = document.getElementById('currentKeys');
        keysDiv.innerHTML = '<div style="padding: 5px; margin: 2px 0; background: rgba(0,255,136,0.1); border-radius: 5px;">üîë DABBE2024VIP</div>';
    }
}

// ƒ∞ndirme fonksiyonu
let currentResult = null;
function downloadResult() {
    if (!currentResult) return;
    const text = JSON.stringify(currentResult, null, 2);
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sorgu_sonucu.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Sayfa y√ºklendiƒüinde
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Dabbe Checker Pro y√ºklendi!');
    // Varsayƒ±lan key'i g√∂ster
    document.getElementById('systemKey').value = 'DABBE2024VIP';
});

// Modal dƒ±≈üƒ±na tƒ±klayƒ±nca kapat
window.onclick = function(event) {
    const modal = document.getElementById('adminModal');
    if (event.target === modal) {
        closeAdminModal();
    }
}
</script>
